#!/bin/bash

splash_crawford() {

echo "${txtylw}  _____ __  _   ____  ____   ___"
echo "${txtylw} / ___/|  |/ ] /    ||    \ /   \\"
echo "${txtylw}(   \_ |  ' / |  o  ||  D  )     |"
echo "${txtylw} \__  ||    \ |     ||    /|  O  |"
echo "${txtylw} /  \ ||     ||  _  ||    \|     |"
echo "${txtylw} \    ||  .  ||  |  ||  .  \     |"
echo "${txtylw}  \___||__|\_||__|__||__|\_|\___/"
echo "${txtcyn}"
}

splash_bubble() {

echo "  _   _   _   _   _"
echo " / \ / \ / \ / \ / \\"
echo "( S | K | A | R | O )"
echo " \_/ \_/ \_/ \_/ \_/"

}

txtred=$(tput setaf 1) #Red
txtgrn=$(tput setaf 2) # Green
txtylw=$(tput setaf 3) # Yellow
txtblu=$(tput setaf 4) # Blue
txtpur=$(tput setaf 5) # Purple
txtcyn=$(tput setaf 6) # Cyan
txtwht=$(tput setaf 7) # White
txtrst=$(tput sgr0) # Text reset.

splash() {
  echo ""
  splash_crawford
}

### osx sux, has no proper readlink.
check_darwin() {
  SKARO_BIN=$( perl -e 'use Cwd "abs_path";print abs_path(shift)' $0 )
  SKARO_BIN=$( dirname $SKARO_BIN )
  SKARO_HOME=$( dirname $SKARO_BIN )
}
check_linux() {
  SKARO_BIN=$(dirname $(readlink -f $0))/../
  SKARO_HOME=$(readlink -f $SKARO_BIN)
  SKARO_BIN=$SKARO_HOME/bin
}

OSTYPE=`uname -s`
CWD=`pwd`

if [ "$OSTYPE" = "Darwin" ]; then
  check_darwin
else
  check_linux
fi


if [ "$JAVA_HOME" = "" ] ; then
  echo "Attempt to reference standard java location on system: /usr/bin."
  #echo "Please set JAVA_HOME"
  #exit -1
  JAVA_HOME=/usr
fi

build_all() {
  cd apps
  for a in `ls`
  do
    cd  $CWD
    ./bin/skaro build $a
  done
}


JPROF=-agentpath:/Applications/jprofiler7/bin/macos/libjprofilerti.jnilib=port=8849
DBGOPTS="-agentlib:jdwp=transport=dt_socket,server=y,address=8787,suspend=n"

PATCHDIR=$SKARO_HOME/patch/*
LIBDIR=$SKARO_HOME/lib/*
HACK=$SKARO_HOME/cout/j/:$SKARO_HOME/cout/c/:$SKARO_HOME/target/*
BOOT=$HACK:$PATCHDIR:$SKARO_HOME/dist/*:$LIBDIR

JAVA_CMD=$JAVA_HOME/bin/java
BG=false

##VMXRGS=" -XX:+CMSClassUnloadingEnabled -XX:+UseConcMarkSweepGC -XX:MaxPermSize=256m"
VMXRGS=" -XX:+CMSClassUnloadingEnabled -XX:+UseConcMarkSweepGC"
MAINCZ=czlab.skaro.etc.shell

LIBP="-Djava.library.path=$SKARO_BIN"
#48G
#VMARGS="-Xms8192m -Xmx49152m"
#36G
#VMARGS="-Xms8192m -Xmx36864m"
#32G
#VMARGS="-Xms8192m -Xmx32768m"
VMARGS="-Xms512m -Xmx7096m $VMXRGS"
LJC=etc/log4jc.xml
LJD=etc/log4j.xml
L4JFILE=
if [ -e $LJD -a -d "logs" ]
then
  L4JFILE=$LJD
elif [ -e $LJC ]
then
  L4JFILE=$LJC
else
  L4JFILE=${SKARO_BIN}/log.xml
fi
LOGCFG=-Dlog4j.configurationFile=file:${L4JFILE}
BASEDIR="-Dskaro.home=$SKARO_HOME"
KPORT=4444
KILLPORT="-Dskaro.kill.port=$KPORT"
NETTY=-Dio.netty.eventLoopThreads=16

show_proc() {
    pid=$( ps -ef | grep czlab.skaro.etc.shell | grep -v grep | awk '{print $2}' )
    if [ -n "$pid" ]; then
      echo "skaro is running with process-id: ${pid}."
    else
      echo "skaro is not running."
    fi
}
stop_proc() {
    pid=$( ps -ef | grep czlab.skaro.etc.shell | grep -v grep | awk '{print $2}' )
    if [ -n "$pid" ]; then
      #kill $pid
      cd /tmp
      wget http://127.0.0.1:$KPORT/kill9 2>&1 > /dev/null
      cd $CWD
    fi
}

if [ $# -eq 2 ] ; then
    if [ "$1" = "start" -a "$2" = "bg" ]; then
       BG=true
    fi
fi

if [ $# -eq 1 -a "$1" = "debug" ]; then
  echo "remote debug mode"
else
  DBGOPTS=
fi

if [ $# -eq 1 -a "$1" = "stop" ]; then
  echo "stopping skaro..."
  stop_proc
  exit $?
fi

if [ $# -eq 1 -a "$1" = "status" ]; then
  show_proc
  exit 0
fi

if [ $# -eq 1 -a "$1" = "build-all" ]; then
  build_all
  exit 0
fi


#CMDLINE="$JAVA_CMD -cp $BOOT $DBGOPTS $LOGREF $BASEDIR $MAINCZ $SKARO_HOME $@ "
#cd $SKARO_BIN
if [ "$BG" = "true" ]; then
  nohup $JAVA_CMD $VMARGS -cp $BOOT $LIBP $DBGOPTS $LOGCFG $NETTY $KILLPORT $BASEDIR $MAINCZ $SKARO_HOME $@ &
else
  splash
  $JAVA_CMD $VMARGS -cp $BOOT $LIBP $DBGOPTS $LOGCFG $NETTY $KILLPORT $BASEDIR  $MAINCZ $SKARO_HOME $@
fi
#cd $CWD
exit $?


